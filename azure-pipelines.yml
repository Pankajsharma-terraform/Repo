trigger: none
# - main
# - features/*

# pool: Stream line project agent

jobs:
  - job: installerjob
    pool: Stream line project agent
    displayName: Terraform installer Job
    steps:
    - task: TerraformInstaller@1
      displayName: Terraform Install
      inputs:
        terraformVersion: 'latest'
  
  - job: initvalidateplanjob
    pool: Stream line project agent
    dependsOn: installerjob
    displayName: Init, Validate, Plan Job
    steps:
    - task: TerraformTask@5
      displayName: Terraform init task
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: 'code stremline-sc'
        backendAzureRmStorageAccountName: 'pankajstrg'
        backendAzureRmContainerName: 'streamlinecont'
        backendAzureRmKey: 'terraform.tfstate'
      
    - task: TerraformTask@5
      displayName: Terraform Validate Task
      inputs:
        provider: 'azurerm'
        command: 'validate'
  
    - task: TerraformTask@5
      displayName: Terraform Plan Task
      inputs:
        provider: 'azurerm'
        command: 'plan'
        environmentServiceNameAzureRM: 'code stremline-sc'

  - job: ManualValidation
    displayName: Manual Validation Step
    dependsOn: initvalidateplanjob
    pool: server
    steps:
    - task: ManualValidation@1
      displayName: Manual Approval Before Apply
      inputs:
        instructions: 'Please review the Terraform plan and approve to continue.'
        notifyUsers: 'pankajsharma.universe@outlook.com'
        approvers: 'pankajsharma.universe@outlook.com'

  - job: initjobaftermanualvalidation
    displayName: Init & Apply After Manual Approval
    dependsOn: ManualValidation
    pool: Stream line project agent
    steps:
    - task: TerraformTask@5
      displayName: Terraform init task
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: 'code stremline-sc'
        backendAzureRmStorageAccountName: 'pankajstrg'
        backendAzureRmContainerName: 'streamlinecont'
        backendAzureRmKey: 'terraform.tfstate'
 
 
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'apply'
        commandOptions: '-auto-approve'
        environmentServiceNameAzureRM: 'code stremline-sc'